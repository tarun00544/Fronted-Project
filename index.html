  <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timetable Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --danger-gradient: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .gradient-card {
            background: var(--primary-gradient);
            color: white;
            border: none;
        }

        .gradient-card.success {
            background: var(--success-gradient);
        }

        .gradient-card.warning {
            background: var(--warning-gradient);
        }

        .gradient-card.danger {
            background: var(--danger-gradient);
        }

        .timetable-header {
            background: var(--primary-gradient);
            color: white;
        }

        .period-cell {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .class-card {
            border-radius: 8px;
            border-left: 4px solid #007bff;
            background-color: #e3f2fd;
            transition: all 0.3s ease;
            cursor: move;
            min-height: 80px;
            padding: 10px;
            margin: 2px;
        }

        .class-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .class-card.locked {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }

        .empty-slot {
            min-height: 80px;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            transition: all 0.3s ease;
            margin: 2px;
        }

        .empty-slot.dragover {
            border-color: #007bff;
            background-color: #e3f2fd;
        }

        .data-card {
            transition: all 0.3s ease;
        }

        .data-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .nav-tabs .nav-link {
            border: none;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            background: var(--primary-gradient);
            color: white;
            border-radius: 8px;
        }

        .stat-card {
            border-radius: 12px;
            overflow: hidden;
        }

        .btn-gradient {
            background: var(--primary-gradient);
            border: none;
            color: white;
            transition: all 0.3s ease;
        }

        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            color: white;
        }

        .section-info {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .timetable-grid {
            overflow-x: auto;
        }

        .timetable-table {
            min-width: 800px;
        }

        .time-cell {
            width: 120px;
            background-color: #f8f9fa;
            font-weight: 600;
            text-align: center;
        }

        .day-header {
            background: var(--primary-gradient);
            color: white;
            text-align: center;
            font-weight: 600;
        }

        .subject-card {
            font-size: 0.85em;
        }

        .subject-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .teacher-name {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .room-name {
            color: #e74c3c;
            font-size: 0.8em;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white">
        <div class="container">
            <div class="navbar-brand d-flex align-items-center">
                <i class="fas fa-calendar-alt text-primary me-3 fs-3"></i>
                <h1 class="h3 mb-0 text-dark">Timetable Manager</h1>
            </div>
            
            <div class="d-flex">
                <ul class="nav nav-tabs border-0">
                    <li class="nav-item">
                        <button class="nav-link active" id="dashboard-tab" onclick="switchTab('dashboard')">
                            <i class="fas fa-home me-2"></i>Dashboard
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="data-tab" onclick="switchTab('data')">
                            <i class="fas fa-database me-2"></i>Data Management
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Dashboard Tab -->
        <div id="dashboard-content" class="tab-content">
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card stat-card gradient-card h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Sections</h6>
                                <h2 class="mb-0" id="sections-count">0</h2>
                            </div>
                            <i class="fas fa-users fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card gradient-card success h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Teachers</h6>
                                <h2 class="mb-0" id="teachers-count">0</h2>
                            </div>
                            <i class="fas fa-user fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card gradient-card warning h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Rooms</h6>
                                <h2 class="mb-0" id="rooms-count">0</h2>
                            </div>
                            <i class="fas fa-door-open fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card gradient-card danger h-100">
                        <div class="card-body d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title">Subjects</h6>
                                <h2 class="mb-0" id="subjects-count">0</h2>
                            </div>
                            <i class="fas fa-book fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timetable Generation -->
            <div class="card shadow-lg">
                <div class="card-body">
                    <h3 class="card-title mb-4">
                        <i class="fas fa-plus-circle me-2"></i>Generate New Timetable
                    </h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Select Section</label>
                            <select id="section-select" class="form-select form-select-lg">
                                <option value="">Choose a section...</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button id="generate-btn" class="btn btn-gradient btn-lg w-100" onclick="generateTimetable()">
                                <i class="fas fa-plus me-2"></i>Generate Timetable
                            </button>
                        </div>
                    </div>

                    <!-- Section Info -->
                    <div id="section-info" class="section-info d-none">
                        <div class="row">
                            <div class="col-md-3">
                                <strong>Section:</strong> <span id="info-section-name"></span>
                            </div>
                            <div class="col-md-3">
                                <strong>Department:</strong> <span id="info-department"></span>
                            </div>
                            <div class="col-md-3">
                                <strong>Year:</strong> <span id="info-year"></span>
                            </div>
                            <div class="col-md-3">
                                <strong>Students:</strong> <span id="info-strength"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Generated Timetable -->
                    <div id="timetable-container" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h4 class="mb-0">Generated Timetable</h4>
                            <div class="text-muted">
                                Total Classes: <span id="total-classes">0</span>
                            </div>
                        </div>
                        <div id="timetable-grid" class="timetable-grid"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Management Tab -->
        <div id="data-content" class="tab-content d-none">
            <div class="row">
                <!-- Subjects -->
                <div class="col-lg-6 mb-4">
                    <div class="card data-card shadow">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-book me-2"></i>Subjects
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="subjects-list" class="overflow-auto" style="max-height: 300px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Teachers -->
                <div class="col-lg-6 mb-4">
                    <div class="card data-card shadow">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>Teachers
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="teachers-list" class="overflow-auto" style="max-height: 300px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Rooms -->
                <div class="col-lg-6 mb-4">
                    <div class="card data-card shadow">
                        <div class="card-header bg-warning text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-door-open me-2"></i>Rooms
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="rooms-list" class="overflow-auto" style="max-height: 300px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Sections -->
                <div class="col-lg-6 mb-4">
                    <div class="card data-card shadow">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-layer-group me-2"></i>Sections
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="sections-list" class="overflow-auto" style="max-height: 300px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let activeTab = 'dashboard';
        let subjects = [];
        let teachers = [];
        let rooms = [];
        let sections = [];
        let currentTimetable = {};
        let selectedSection = null;
        let sectionTimetables = {}; // Store timetables for each section

        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
        const periods = [1, 2, 3, 4, 5, 6, 7, 8];
        const timeSlots = [
            '9:00-10:00',
            '10:00-10:55', 
            '10:55-11:45',
            '11:45-12:40',
            '1:30-2:20',
            '2:20-3:10',
            '3:10-4:00',
            '4:00-5:00'
        ];

        // Initialize sample data
        function initializeSampleData() {
            subjects = [
                { id: 1, name: 'Mathematics', code: 'MATH101', hours_per_week: 5, requires_lab: false, departments: ['Computer Science', 'Information Technology', 'Electronics', 'Mechanical'] },
                { id: 2, name: 'Physics', code: 'PHY101', hours_per_week: 4, requires_lab: true, departments: ['Computer Science', 'Electronics', 'Mechanical'] },
                { id: 3, name: 'English', code: 'ENG101', hours_per_week: 3, requires_lab: false, departments: ['Computer Science', 'Information Technology', 'Electronics', 'Mechanical', 'Civil'] },
                { id: 4, name: 'Java Programming', code: 'JAVA101', hours_per_week: 4, requires_lab: true, departments: ['Computer Science', 'Information Technology'] },
                { id: 5, name: 'Python Programming', code: 'PYT101', hours_per_week: 5, requires_lab: true, departments: ['Computer Science', 'Information Technology', 'Electronics', 'Mechanical'] },
                { id: 6, name: 'Data Structures', code: 'DS101', hours_per_week: 4, requires_lab: true, departments: ['Computer Science', 'Information Technology'] },
                { id: 7, name: 'Web Development', code: 'WEB101', hours_per_week: 3, requires_lab: true, departments: ['Computer Science', 'Information Technology'] },
                { id: 8, name: 'Environmental Science', code: 'EVS101', hours_per_week: 2, requires_lab: false, departments: ['Computer Science', 'Information Technology', 'Electronics', 'Mechanical', 'Civil'] },
                { id: 9, name: 'Digital Electronics', code: 'DE101', hours_per_week: 4, requires_lab: true, departments: ['Electronics'] },
                { id: 10, name: 'Signal Processing', code: 'SP101', hours_per_week: 3, requires_lab: true, departments: ['Electronics'] },
                { id: 11, name: 'Thermodynamics', code: 'TD101', hours_per_week: 4, requires_lab: false, departments: ['Mechanical'] },
                { id: 12, name: 'Machine Design', code: 'MD101', hours_per_week: 3, requires_lab: true, departments: ['Mechanical'] },
                { id: 13, name: 'Structural Engineering', code: 'SE101', hours_per_week: 4, requires_lab: false, departments: ['Civil'] },
                { id: 14, name: 'Surveying', code: 'SUR101', hours_per_week: 3, requires_lab: true, departments: ['Civil'] },
                { id: 15, name: 'Database Systems', code: 'DB101', hours_per_week: 4, requires_lab: true, departments: ['Computer Science', 'Information Technology'] },
                { id: 16, name: 'Operating Systems', code: 'OS101', hours_per_week: 3, requires_lab: false, departments: ['Computer Science', 'Information Technology'] },
                { id: 17, name: 'Computer Networks', code: 'CN101', hours_per_week: 4, requires_lab: true, departments: ['Computer Science', 'Information Technology'] },
                { id: 18, name: 'Chemistry', code: 'CHEM101', hours_per_week: 4, requires_lab: true, departments: ['Computer Science', 'Electronics', 'Mechaical', 'Civil']}
            ];

            teachers = [
                { id: 1, name: 'Dr. Brijesh Singh', department: 'Mathematics', subjects: ['Mathematics'] },
                { id: 2, name: 'Prof. Neha Sharma', department: 'Physics', subjects: ['Physics'] },
                { id: 3, name: 'Dr. Shubham Sharma', department: 'Chemistry', subjects: ['Chemistry'] },
                { id: 4, name: 'Ms. Brahmjot Kaur', department: 'English', subjects: ['English'] },
                { id: 5, name: 'Dr. Kanchan Sharma', department: 'Computer Science', subjects: ['Java Programming', 'Data Structures'] },
                { id: 6, name: 'Mr. Amandeep Singh', department: 'Computer Science', subjects: ['Python Programming', 'Web Development'] },
                { id: 7, name: 'Ms. Navneet Kaur', department: 'Computer Science', subjects: ['Database Systems', 'Operating Systems'] },
                { id: 8, name: 'Mr. Manju Goyal', department: 'Computer Science', subjects: ['Computer Networks'] },
                { id: 9, name: 'Ms. Mudit Arora', department: 'Information Technology', subjects: ['Web Development', 'Database Systems'] },
                { id: 10, name: 'Dr. Jayishnu Singla', department: 'Environmental Science', subjects: ['Environmental Science'] },
                { id: 11, name: 'Prof. Rajesh Kumar', department: 'Electronics', subjects: ['Digital Electronics', 'Signal Processing'] },
                { id: 12, name: 'Dr. Priya Mehta', department: 'Electronics', subjects: ['Digital Electronics'] },
                { id: 13, name: 'Mr. Vikram Singh', department: 'Mechanical', subjects: ['Thermodynamics', 'Machine Design'] },
                { id: 14, name: 'Dr. Sunita Jain', department: 'Mechanical', subjects: ['Machine Design'] },
                { id: 15, name: 'Prof. Ravi Gupta', department: 'Civil', subjects: ['Structural Engineering', 'Surveying'] },
                { id: 16, name: 'Ms. Kavya Patel', department: 'Civil', subjects: ['Surveying'] }
            ];

            rooms = [
                { id: 1, name: 'Room 101', capacity: 40, room_type: 'lecture', building: 'A' },
                { id: 2, name: 'Lab 201', capacity: 30, room_type: 'lab', building: 'B' },
                { id: 3, name: 'Room 102', capacity: 35, room_type: 'lecture', building: 'A' },
                { id: 4, name: 'Lab 202', capacity: 25, room_type: 'lab', building: 'B' },
                { id: 5, name: 'Seminar Hall', capacity: 70, room_type: 'seminar', building: 'C' },
                { id: 6, name: 'Room 103', capacity: 45, room_type: 'lecture', building: 'A' },
                { id: 7, name: 'Lab 203', capacity: 20, room_type: 'lab', building: 'B' },
                { id: 8, name: 'Room 104', capacity: 50, room_type: 'lecture', building: 'A' },
                { id: 9, name: 'Lab 204', capacity: 30, room_type: 'lab', building: 'B' },
                { id: 10, name: 'Conference Hall', capacity: 100, room_type: 'seminar', building: 'C' },
                { id: 11, name: 'Room 105', capacity: 40, room_type: 'lecture', building: 'A' },
                { id: 12, name: 'Lab 205', capacity: 35, room_type: 'lab', building: 'B' },
                { id: 13, name: 'Room 106', capacity: 30, room_type: 'lecture', building: 'A' },
                { id: 14, name: 'Lab 206', capacity: 25, room_type: 'lab', building: 'B' },
                { id: 15, name: 'Auditorium', capacity: 150, room_type: 'seminar', building: 'C' }
            ];

            sections = [
                { id: 1, name: 'CS-A', year: 1, department: 'Computer Science', strength: 35 },
                { id: 2, name: 'CS-B', year: 1, department: 'Computer Science', strength: 30 },
                { id: 3, name: 'CS-C', year: 2, department: 'Computer Science', strength: 50 },
                { id: 4, name: 'IT-A', year: 1, department: 'Information Technology', strength: 40 },
                { id: 5, name: 'IT-B', year: 2, department: 'Information Technology', strength: 45 },
                { id: 6, name: 'EC-A', year: 1, department: 'Electronics', strength: 25 },
                { id: 7, name: 'EC-B', year: 2, department: 'Electronics', strength: 30 },
                { id: 8, name: 'ME-A', year: 1, department: 'Mechanical', strength: 20 },
                { id: 9, name: 'ME-B', year: 2, department: 'Mechanical', strength: 22 },
                { id: 10, name: 'CE-A', year: 1, department: 'Civil', strength: 28 },
                { id: 11, name: 'CE-B', year: 2, department: 'Civil', strength: 32 }
            ];
             
            updateStatCards();
            populateSectionSelect();
            renderDataLists();
        }

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('d-none'));
            document.getElementById(tab + '-content').classList.remove('d-none');

            activeTab = tab;
        }

        // Update stat cards
        function updateStatCards() {
            document.getElementById('sections-count').textContent = sections.length;
            document.getElementById('teachers-count').textContent = teachers.length;
            document.getElementById('rooms-count').textContent = rooms.length;
            document.getElementById('subjects-count').textContent = subjects.length;
        }

        // Populate section select
        function populateSectionSelect() {
            const select = document.getElementById('section-select');
            select.innerHTML = '<option value="">Choose a section...</option>';
            
            sections.forEach(section => {
                const option = document.createElement('option');
                option.value = section.id;
                option.textContent = `${section.name} - ${section.department} (Year ${section.year})`;
                select.appendChild(option);
            });

            select.addEventListener('change', function() {
                selectedSection = this.value ? parseInt(this.value) : null;
                if (selectedSection) {
                    showSectionInfo();
                    // Check if timetable already exists for this section
                    if (sectionTimetables[selectedSection]) {
                        displayTimetable(sectionTimetables[selectedSection]);
                    } else {
                        document.getElementById('timetable-container').classList.add('d-none');
                    }
                } else {
                    hideSectionInfo();
                }
            });
        }

        // Show section information
        function showSectionInfo() {
            const section = sections.find(s => s.id === selectedSection);
            if (section) {
                document.getElementById('info-section-name').textContent = section.name;
                document.getElementById('info-department').textContent = section.department;
                document.getElementById('info-year').textContent = `Year ${section.year}`;
                document.getElementById('info-strength').textContent = section.strength;
                document.getElementById('section-info').classList.remove('d-none');
            }
        }

        // Hide section information
        function hideSectionInfo() {
            document.getElementById('section-info').classList.add('d-none');
            document.getElementById('timetable-container').classList.add('d-none');
        }

        // Get subjects for a department and year
        function getSubjectsForSection(section) {
            let availableSubjects = subjects.filter(subject => 
                subject.departments.includes(section.department)
            );

            // Filter subjects based on year and department
            if (section.department === 'Computer Science') {
                if (section.year === 1) {
                    availableSubjects = availableSubjects.filter(s => 
                        ['Mathematics', 'Physics', 'English', 'Java Programming', 'Environmental Science'].includes(s.name)
                    );
                } else {
                    availableSubjects = availableSubjects.filter(s => 
                        ['Data Structures', 'Python Programming', 'Database Systems', 'Operating Systems', 'Computer Networks', 'Web Development'].includes(s.name)
                    );
                }
            } else if (section.department === 'Information Technology') {
                if (section.year === 1) {
                    availableSubjects = availableSubjects.filter(s => 
                        ['Mathematics', 'Physics', 'English', 'Java Programming', 'Environmental Science'].includes(s.name)
                    );
                } else {
                    availableSubjects = availableSubjects.filter(s => 
                        ['Web Development', 'Database Systems', 'Computer Networks', 'Python Programming'].includes(s.name)
                    );
                }
            } else if (section.department === 'Electronics') {
                if (section.year === 1) {
                    availableSubjects = availableSubjects.filter(s => 
                        ['Mathematics', 'Physics', 'English', 'Environmental Science'].includes(s.name)
                    );
                } else {
                    availableSubjects = availableSubjects.filter(s => 
                        ['Digital Electronics', 'Signal Processing', 'Mathematics', 'Physics'].includes(s.name)
                    );
                }
            } else if (section.department === 'Mechanical') {
                if (section.year === 1) {
                    availableSubjects = availableSubjects.filter(s => 
                        ['Mathematics', 'Physics', 'English', 'Environmental Science'].includes(s.name)
                    );
                } else {
                    availableSubjects = availableSubjects.filter(s => 
                        ['Thermodynamics', 'Machine Design', 'Mathematics', 'Physics'].includes(s.name)
                    );
                }
            } else if (section.department === 'Civil') {
                if (section.year === 1) {
                    availableSubjects = availableSubjects.filter(s => 
                        ['Mathematics', 'Physics', 'English', 'Environmental Science'].includes(s.name)
                    );
                } else {
                    availableSubjects = availableSubjects.filter(s => 
                        ['Structural Engineering', 'Surveying', 'Mathematics', 'Physics'].includes(s.name)
                    );
                }
            }

            return availableSubjects;
        }

        // Get teachers for subjects
        function getTeachersForSubjects(subjectNames) {
            return teachers.filter(teacher => 
                teacher.subjects.some(subject => subjectNames.includes(subject))
            );
        }

        // Get appropriate room for subject
        function getRoomForSubject(subject, usedRoomsForSlot = [], sectionStrength = 30) {
            const roomType = subject.requires_lab ? 'lab' : 'lecture';
            let availableRooms = rooms.filter(room => 
                room.room_type === roomType && 
                !usedRoomsForSlot.includes(room.id) &&
                room.capacity >= sectionStrength
            );
            
            if (availableRooms.length === 0) {
                // If no rooms of preferred type, use any available room with sufficient capacity
                availableRooms = rooms.filter(room => 
                    !usedRoomsForSlot.includes(room.id) && 
                    room.capacity >= sectionStrength
                );
            }
            
            if (availableRooms.length === 0) {
                // If still no rooms, use any available room
                availableRooms = rooms.filter(room => !usedRoomsForSlot.includes(room.id));
            }
            
            return availableRooms.length > 0 ? availableRooms[Math.floor(Math.random() * availableRooms.length)] : rooms[0];
        }

        // Generate timetable for selected section
        function generateTimetable() {
            if (!selectedSection) {
                alert('Please select a section first!');
                return;
            }

            const section = sections.find(s => s.id === selectedSection);
            const sectionSubjects = getSubjectsForSection(section);
            const sectionTeachers = getTeachersForSubjects(sectionSubjects.map(s => s.name));
            
            // Create new timetable
            const timetable = {};
            days.forEach(day => {
                timetable[day] = {};
                periods.forEach(period => {
                    timetable[day][period] = null;
                });
            });

            // Generate classes based on subjects and their weekly hours
            const classesToSchedule = [];
            
            sectionSubjects.forEach(subject => {
                const hoursNeeded = Math.min(subject.hours_per_week, 8); // Max 8 periods per week
                
                for (let i = 0; i < hoursNeeded; i++) {
                    const availableTeachers = sectionTeachers.filter(t => t.subjects.includes(subject.name));
                    const teacher = availableTeachers[Math.floor(Math.random() * availableTeachers.length)];
                    
                    if (teacher) {
                        classesToSchedule.push({
                            subject: subject,
                            teacher: teacher,
                            isLab: subject.requires_lab && (i % 2 === 0) // Alternate between theory and lab
                        });
                    }
                }
            });

            // Schedule classes randomly but ensure no conflicts
            const usedSlots = new Map(); // Track used teacher-time slots
            const usedRooms = new Map(); // Track used room-time slots
            
            classesToSchedule.forEach(classInfo => {
                let scheduled = false;
                let attempts = 0;
                
                while (!scheduled && attempts < 50) {
                    const randomDay = days[Math.floor(Math.random() * days.length)];
                    const randomPeriod = periods[Math.floor(Math.random() * periods.length)];
                    const slotKey = `${randomDay}-${randomPeriod}`;
                    
                    // Check if slot is empty
                    if (!timetable[randomDay][randomPeriod]) {
                        // Check teacher availability
                        const teacherKey = `${classInfo.teacher.id}-${slotKey}`;
                        
                        if (!usedSlots.has(teacherKey)) {
                            // Get available room for this slot
                            const usedRoomsForSlot = Array.from(usedRooms.keys())
                                .filter(key => key.endsWith(`-${slotKey}`))
                                .map(key => parseInt(key.split('-')[0]));
                                
                            const room = getRoomForSubject(classInfo.subject, usedRoomsForSlot, section.strength);
                            const roomKey = `${room.id}-${slotKey}`;
                            
                            if (!usedRooms.has(roomKey)) {
                                // Schedule the class
                                timetable[randomDay][randomPeriod] = {
                                    subject: classInfo.subject,
                                    teacher: classInfo.teacher,
                                    room: room,
                                    is_locked: false,
                                    isLab: classInfo.isLab
                                };
                                
                                usedSlots.set(teacherKey, true);
                                usedRooms.set(roomKey, true);
                                scheduled = true;
                            }
                        }
                    }
                    attempts++;
                }
            });

            // Store timetable for this section
            sectionTimetables[selectedSection] = timetable;
            currentTimetable = timetable;
            
            // Display the timetable
            displayTimetable(timetable);
        }

        // Display timetable in a table format
        function displayTimetable(timetable) {
            const container = document.getElementById('timetable-grid');
            let totalClasses = 0;
            
            // Count total scheduled classes
            days.forEach(day => {
                periods.forEach(period => {
                    if (timetable[day] && timetable[day][period]) {
                        totalClasses++;
                    }
                });
            });
            
            document.getElementById('total-classes').textContent = totalClasses;
            
            let html = `
                <div class="table-responsive">
                    <table class="table table-bordered timetable-table">
                        <thead>
                            <tr>
                                <th class="time-cell">Time</th>
                                ${days.map(day => `<th class="day-header">${day}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            periods.forEach((period, index) => {
                html += `<tr>`;
                html += `<td class="time-cell">Period ${period}<br><small>${timeSlots[index]}</small></td>`;
                
                days.forEach(day => {
                    const classData = timetable[day] ? timetable[day][period] : null;
                    
                    if (classData) {
                        html += `
                            <td>
                                <div class="class-card subject-card ${classData.is_locked ? 'locked' : ''}">
                                    <div class="subject-name">${classData.subject.name}</div>
                                    <div class="teacher-name">${classData.teacher.name}</div>
                                    <div class="room-name">${classData.room.name}</div>
                                    ${classData.isLab ? '<small class="badge bg-info">Lab</small>' : ''}
                                </div>
                            </td>
                        `;
                    } else {
                        html += `<td><div class="empty-slot">Free</div></td>`;
                    }
                });
                
                html += `</tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
            document.getElementById('timetable-container').classList.remove('d-none');
        }

        // Render data lists in the data management tab
        function renderDataLists() {
            renderSubjectsList();
            renderTeachersList();
            renderRoomsList();
            renderSectionsList();
        }

        function renderSubjectsList() {
            const container = document.getElementById('subjects-list');
            let html = '';
            
            subjects.forEach(subject => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${subject.name}</strong> (${subject.code})
                                    <br><small class="text-muted">${subject.hours_per_week} hrs/week • ${subject.requires_lab ? 'Lab Required' : 'Theory Only'}</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">${subject.departments.join(', ')}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderTeachersList() {
            const container = document.getElementById('teachers-list');
            let html = '';
            
            teachers.forEach(teacher => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${teacher.name}</strong>
                                    <br><small class="text-muted">${teacher.department}</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">${teacher.subjects.join(', ')}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderRoomsList() {
            const container = document.getElementById('rooms-list');
            let html = '';
            
            rooms.forEach(room => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${room.name}</strong>
                                    <br><small class="text-muted">Building ${room.building} • Capacity: ${room.capacity}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-${room.room_type === 'lab' ? 'warning' : room.room_type === 'seminar' ? 'info' : 'primary'}">${room.room_type}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function renderSectionsList() {
            const container = document.getElementById('sections-list');
            let html = '';
            
            sections.forEach(section => {
                html += `
                    <div class="card mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${section.name}</strong>
                                    <br><small class="text-muted">${section.department} • Year ${section.year}</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">${section.strength} students</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSampleData();
        });
    </script>
</body>
</html>
